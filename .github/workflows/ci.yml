name: CI

on:
  push:
    branches: [main]

jobs:
  # ── 1. Lint ────────────────────────────────────────────────────────────────
  lint:
    name: Lint (ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install ruff
      - run: ruff check . --output-format=github

  # ── 2. Syntax check ────────────────────────────────────────────────────────
  syntax:
    name: Syntax check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Compile all Python files
        run: python -m compileall -q .

  # ── 3. Unit tests ──────────────────────────────────────────────────────────
  test:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements-ci.txt
      - name: Install test dependencies
        run: pip install -r requirements-ci.txt pytest
      - name: Run tests
        run: pytest tests/ -v --tb=short

  # ── 4. Full dependency install check ──────────────────────────────────────
  # Verifies requirements.txt installs cleanly (same environment Streamlit Cloud uses).
  # prophet and great-expectations are heavy — this job may take 3-5 minutes.
  deps:
    name: Dependency install
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt
      - name: Install all dependencies
        run: pip install -r requirements.txt

  # ── 5. Deploy gate ─────────────────────────────────────────────────────────
  # Streamlit Cloud auto-deploys when this push lands on main.
  # This job acts as a summary gate — all checks must pass before it succeeds.
  # Pair with GitHub branch protection (require status checks) to block bad deploys.
  deploy-gate:
    name: Deploy gate
    runs-on: ubuntu-latest
    needs: [lint, syntax, test, deps]
    steps:
      - name: All checks passed — Streamlit Cloud deployment triggered
        run: |
          echo "✅ lint, syntax, tests, and dependency install all passed."
          echo "Streamlit Cloud will deploy from: ${{ github.sha }}"
          echo "App URL: https://port-disruption-risk.streamlit.app"
